---
layout: article
title:  "hadoop2.0 yarn原理"
categories: hadoop
toc: true
image:
    teaser: /teaser/Hadoop-YARN.jpg
---

> 本文简单地讲述hadoop mapreduceV2 框架 yarn的工作原理。由于mapreduceV1框架在大集群中面临着扩展性瓶颈，mapreduceV2框架Yarn完美解决

### 前言
&emsp;&emsp;以下内容主要是通过在学习和工作中的一些总结和感悟，很多概念上的东西都主要来自于书籍和网络，毕竟这些基础知识还是以官网为准。
### yarn框架图

来源于官网的yarn架构图：

![YARN架构图](/images/hadoop/YARN/yarn_Architecture.png)

如上图，yarn将原本mrV1中JobTrack的的职能划分为多个独立的实体，包括管理集群资源的资源管理器和管理集群上运行任务生命周期的应用管理器。 应用服务器和资源管理器协商分配集群的计算资源：容器。容器是yarn为集群资源进行隔离而提出来的框架，容器是一个动态分配的资源单位， 其将cpu、内存、磁盘、网络等资源封装成为一个实体。每一个任务对应一个容器，所以任务只能在对应的容器里跑的。 容器由集群节点上运行的节点管理器进行监视，确保应用程序使用的资源不会超过其被分配的资源。 所以yarn框架里有3个重要的M分别是：
{% highlight bash %}
{% raw %}

RM      Resource Manager        资源管理器
AM      Application Master      应用程序管理器
NM      Node Manager            节点管理器
{% endraw %}
{% endhighlight %}

yarn比mrV1包括更多的实体：
*   提交mapreduce作业的客户端
*   yarn资源管理器， 负责协调集群上计算资源的分配
*   yarn节点管理器， 负责启动和监视集群中机器上的计算容器。
*   应用程序管理器， 负责协调运行mapreduce作业的任务， 其和mapreduce任务都在容器中运行， 这些容器由资源管理器分配并且由节点管理器进行管理。
*   hdfs， 用来和其他实体间共享作业文件。

### 下面分别讲解这3M

#### 资源管理器 RM

RM是一个全局的资源管理器，其负责整个系统资源的管理，和AM协调应用程序资源的分配。RM主要分为调度器和ASM（Applications Manager）。

调度器：调度器根据系统状态将系统中的资源分配给正在运行的应用程序，调度器只关注系统调度工作而不参与应用程序相关的其他工作， 如状态监控、重启失败任务等。调度器会与AM相协调， 根据每个应用程序的资源需求进行分配资源，这个资源其实就是上面提到过的容器。 yarn提供多种直接可用的调度器，如公平调度（fair scheduler）、容量调度（capacity scheduler）。 调度器还是一个可插拔的部分， 用户可用根据自己的需要实现满足需求的调度器。

#### ASM

ASM是负责管理整个系统中所有应用程序的，包括应用程序提交、与调度器协商启动AM需要的资源、监控AM运行状态、AM失败时重启AM。 所以ASM的作用更体现在管理AM上，在作业提交后，负责与调度器协调分配AM运行的资源，然后跟NM通信，启动和监控AM。

#### 节点管理器 NM

在集群的节点上都有一个资源和任务管理器，称为节点管理器（NM）。NM负责启动容器、AM并且定时地向RM汇报本节点上的资源情况和容器的状态。

#### 应用程序管理器 AM

用户提交的每一个应用程序都包含AM，所以AM使用用户编写的代码，从yarn框架的角度来看，这些用户代码潜在安全问题，所以yarn会假设AM是存在漏洞的， 无法当作特权代码来运行。 AM的主要功能：
```
1、与RM的调度器协商获取资源，其实就是容器了。
2、与NM通信得以启动或者停止任务。
3、监控任务。任务通过umbilical定时向AM汇报进度和状态。
4、与客户端通信，汇报进度给客户端。
```
### yarn的工作流程

当用户向系统提交一个应用程序（作业）后，yarn会分两个阶段运行这个程序：

1、启动AM。

2、由AM启动创建应用程序中的任务并且监控其状态，直到其运行完成或者无法完成而失败。

作业运行过程

当用户向系统提交一个作业时，这个作业的具体生命周期如下：
{% highlight bash %}
{% raw %}
1、用户提交作业，从RM上获取作业ID。yarn实现了ClientProtocol，当mapreduce.framwork.name为yarn时启动。

2、RM为作业分配一个容器以运行AM。当容器被分配后，RM与对应的NM通信， 要求其在对应的容器内启动AM。

3、AM向RM注册，用户可以通过RM看到作业的状态。然后AM轮询地为每个任务向RM申请资源，并且监控这些任务直到其完成或者失败。即重复下述的4～7。

4、AM采取轮询的方式通过RPC向RM申请资源。

5、得到资源后，与NM通信，启动对应的任务。

6、NM为任务配置运行环境（jar、环境变量等），启动任务。

7、各个任务通过RPC向AM汇报自身的状态、进度等信息。

8、当作业完成后，AM向RM注销并且关闭自己。

作业提交后，客户端可以向AM查看作业的状态，所以在作业提交后，作业的运行跟client机器（不在集群里）没有太大的关系。 而作业里的多个任务可以并行地在集群里不同的节点上运行，从而提高运行效率。
{% endraw %}
{% endhighlight %}