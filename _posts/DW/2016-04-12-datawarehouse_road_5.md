---
layout: article
title:  "数据仓库之路(五)"
categories: DW
toc: true
image:
    teaser: /teaser/hive_sql1.png
---

> 本文主要介绍在w公司的数据仓库之数据监控


### 前言
&emsp;&emsp;主要想记录自己在w公司以来的经历和成长，挤出些时间对自己两年以来坐下总结，以便对下一步的道路进行更好的规划。
### 文章概述
数据仓库在各种原始业务数据的抽取，转换、中间处理，加载及对外接口推送过程中，需要设置对各个环节进行监控，获取其运行的情况，同时针对不同优先级的异常信息进行告警，及早发现，以此来保证线上的仓库正常运行。
### ETL处理过程中存在的问题
   
    * Shell脚本调用第三方接口如Hive时，错误信息不能直接捕获
   
    * 部分功能的运行错误需要解析日志才能捕获，如Sqlldr中reject的行数等
   
    * 调度工具Kettle不能捕获非sh自身的错误，造成后续作业继续运行
   
    * 仓库Hadoop处理增量合并时，增量是否合并成功，是否存在当天数据等
   
## 数据监控功能概述
结合目前仓库的情况，整理梳理后，截至目前大致监控的类型可分为如下几部分:

* Hadoop文件的监控

 应用场景：主要监控HDFS上文件目录是否存在正确的分区，如大部分作业都会依赖的中间层订单表目录: /层1/层2/$table_name/dt=’$date’

* 文件及目录大小检查

 应用场景：仓库中有些表是采用增量合并全量的逻辑，通过判定当天分区下文件的大小是否大于昨天分区的大小，或是否在指定的域值内。

* 运行日志监控

 通过分析运行日志，一方面对部分运行日志不方便实时获取到的点，需要通过分析其运行日志来捕获运行异常问题，

 应用场景：如仓库Shell中调用Hive的过程中，出现的Hsql异常，Hadoop集群资源异常或JavaOOM的问题。通过分析日志，采集运行启动时间、结束时间、处理的数据量

## 元数据监控

* 数据元数据监控
    
   主要针对目前Kettle的运行日志元数据监控，通过查询Kettle的运行日志数据库，获取到某个JOB或Trans运行异常等  
* 业务元数据监控,如模型一致性等后期再考虑

## 数据质量监控
 结合目前仓库的情况，数据质量监控从如下四个方面进行监控
* 非空值检查，如交易数据中的卖家id，买家
* 数据类型检查，如日志中日期类型字段
* 业务规则检查，如商品编码长度、订单金额必须大于0等
* 一致性检查，如同层的数据效验，不同层间的数据效验等
* 完整性检查，如订单主表与订单商品表是否能全部关联上等

## 运行环境监控
 由于针对系统服务器硬件，IT运维组有独立的监控，所以本功能只考虑针对运行时空间大小进行监控，防止出现运行时数据把目录撑满，提前预防等情况，：
* HDFS目录空间(数据及临时目录)
* 共享及目录空间
* 接收日志目录空间

## 告警功能:
* 针对不同的监控问题级别，调用IT运维监控的短信报警接口或邮件接口，发送报警短信或邮件。